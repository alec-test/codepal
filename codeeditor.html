<!DOCTYPE>
<html>
	<head>
		<title>Code Editor</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<!-- Stylesheets -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />

		<!-- Styles -->
		<style type="text/css">
			#editor { 
			    margin: auto;
			    width: 100%;
			    height: 200px;
			}
	    </style>
	</head>
	<body>

		<!-- Main -->
		<div class="container">

			<div id="editor"></div>
			
			<!-- TODO: some sort of element to hold console -->
			<div id="output"></div>

			<div class="col-sm-6">
				<select class="form-control" name="lang" id="lang">
	            	<option value="JavaScript">JavaScript (Node.js v4.4.3)</option>
	                <option value="C#">C# (mono 4.2.3)</option>
	                <option value="C++">C++ (g++ 4.8.4)</option>
	                <option value="Haskell">Haskell (ghc 7.6.3)</option>
	                <option value="Java">Java</option>
	                <option value="Objective-C">Objective-C</option>
	                <option value="Perl">Perl</option>
	                <option value="Pascal">Pascal</option>
	                <option value="Python">Python</option>
	            </select>
			</div>
			<div class="col-sm-6 text-center">
				<button id="compileBtn" type="button" class="btn btn-default">Compile</button>
				<button id="runBtn" type="button" class="btn btn-default">Run</button>
			</div>
		</div>

		<!-- Scripts -->
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/ace.js" data-ace-base="ace" type="text/javascript" charset="utf-8"></script>
		
		<!--
			For local testing:
			http://stackoverflow.com/questions/20035101/no-access-control-allow-origin-header-is-present-on-the-requested-resource
		-->

		<!-- Factory Function -->
		<script type="text/javascript">
			function CodeEditor(options) {

				var clientSecretKey = '9b3e30247878ad73b13bdae8a333c74afe4877fb', // TODO: move to env var later
					aceEditor,
					lang, 
					theme,
					aceLangMap = { // user label to ace .js file name 
						'C#'			: 'csharp',
						'C++'			: 'c_pp',
						'Haskell'		: 'haskell',
						'Java'			: 'java',
						'JavaScript'	: 'javascript',
						'Objective-C'	: 'objectivec',
						'Perl'			: 'perl',
						'Pascal'		: 'pascal',
						'Python'		: 'python'	
					},
					hackerLangMap = { // user label hacker earth lang format 
						'C'				: 'C',
						'C++'			: 'CPP',
						'Clojure'		: 'CLOJURE',
						'C#'			: 'CSHARP',
						'Go'			: 'GO',
						'Haskell'		: 'HASKELL',
						'Java'			: 'JAVA',
						'JavaScript'	: 'JAVASCRIPT_NODE',
						'Objective-C'	: 'OBJECTIVEC',
						'Pascal'		: 'PASCAL',
						'Perl'			: 'PERL',
						'Python'		: 'PYTHON',
						'R'				: 'R',
						'Ruby'			: 'RUBY',
						'Scala'			: 'Scala'
					}; // ommitted CPP11, PHP, RUST

				// EXECUTE module
				var execute = (function() {

					function compile() {
						$.ajax({
							url: 'https://api.hackerearth.com/v3/code/compile/',
							type: 'POST',
							dataType: 'json',
							data: {
								client_secret: clientSecretKey,
								lang: hackerLangMap[lang],
								source: editor.getEditorText()
							},
						})
						.done(function(data, textStatus, jqXHR) {
							// TODO: Parse response and determine whether compilation was successful
							// TODO: IF compile_status === 'OK' -> display success in console
							// TODO: IF compile_status !== 'OK' -> display compile_status val in console 
							console.log("success");
							console.log(data);
							console.log(textStatus);
							console.log(jqXHR);
						})
						.fail(function(jqXHR, textStatus, errorThrown) {
							// Going here means security issue (CORS, authentication) or
							// 	improper input
							// TODO: Research error cases.
							// TODO: Display generic error msg ('try again?') ('refresh')
							console.log("error");
							console.log(jqXHR);
							console.log(textStatus);
							console.log(errorThrown);
						});
					}

					function run() {
						$.ajax({
							url: 'https://api.hackerearth.com/v3/code/run/',
							type: 'POST',
							dataType: 'json',
							data: {
								client_secret: clientSecretKey,
								lang: hackerLangMap[lang],
								source: editor.getEditorText()
							},
						})
						.done(function(data, textStatus, jqXHR) {
							resp = data.run_status;

							if (resp.stderr) { // compilation failure
								$('#output').html(resp.stderr);
							} else {
								$('#output').html(resp.output_html);
							}
							// JS:
							// ON ERR: data.run_status.stderr
							// ON SUCCESS: data.run_status.output OR data.run_status.output_html   

							// ON BOTH: data.run_status.time_used
							console.log("success");
							console.log(data);
						})
						.fail(function(jqXHR, textStatus, errorThrown) {
							// TODO: properly implement
							console.log("error");
							console.log(jqXHR);
							console.log(textStatus);
							console.log(errorThrown);
						});
					}

					return {
						compile : compile,
						run 	: run
 					};

				})();

				// EDITOR module
				var editor = (function() {

					function initEditor(eleId, theme, lang) {
						aceEditor = ace.edit(eleId);
						setEditorTheme(theme);
						setEditorLang(lang);
					    aceEditor.setAutoScrollEditorIntoView(true);
			    		aceEditor.getSession().setTabSize(4);
					}

					function getEditorText() {
						return aceEditor.getValue();
					}

					function setEditorTheme(theme) {
						if (typeof(aceEditor) === 'undefined') {
							return;
						}
						aceEditor.setTheme("ace/theme/" + theme);
					}

					function setEditorLang(newLang) {
						if (typeof(aceEditor) === 'undefined') {
							return;
						}
						lang = newLang;
						aceEditor.getSession().setMode("ace/mode/" + aceLangMap[lang]);
					}

					return {
						initEditor		: initEditor,
						getEditorText	: getEditorText,
						setEditorTheme	: setEditorTheme,
						setEditorLang	: setEditorLang
					};

				})();

				// "CONSTRUCTOR"
				(function() {
					theme = options.theme;
					lang = options.lang;
					editor.initEditor(options.eleId, theme, lang);
				})();

				// Return modules
				return {
					editor 		: editor,
					execute 	: execute
				};

			}
		</script>

		<!-- Main Script -->
		<script type="text/javascript">
			
			var codeEditor; // global class instance

			$(document).ready(function() {

			    codeEditor = CodeEditor({
			        eleId		: 'editor',
			        lang 		: 'JavaScript',
			        theme 		: 'monokai'
			    });

			    // Bindings
			    $('#compileBtn').on('click', codeEditor.execute.compile);
			    $('#runBtn').on('click', codeEditor.execute.run);

			    // TODO: Move change to a separate module
			    // TODO: some languages don't need to compile (e.g. Python, JavaScript). Disable
			    //	button when switching to these langs.
			    $('#lang').on('change', function() {
			    	var lang = $(this).find('option:selected').val();
			        codeEditor.editor.setEditorLang(lang);
			    });

			});

		</script>
	</body>
</html>
