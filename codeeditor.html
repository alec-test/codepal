<!DOCTYPE>
<html>
	<head>
		<title>Code Editor</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<!-- Stylesheets -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

		<!-- Styles -->
		<style type="text/css">
			#editor { 
				margin: auto;
				width: 100%;
				min-height: 200px;
			}
		</style>
	</head>
	<body>

		<!-- Main -->
		<section id="codeeditor" class="container">
			<!-- UI COMPONENT -->
			<div class="row">
				<div class="col-sm-6">
					<label for"filename">Filename</label>
					<input id="filename" type="text" />
					<span id="extension"></span>
					<button type="button" id="downloadBtn"><i class="fa fa-download"></i> Download</button>
					<button type="button" id="saveBtn"><i class="fa fa-save"></i> Save</button>
				</div>
				<div class="col-sm-6 text-right">
					<button data-toggle="modal" data-target="#configModal" type="button" id="configBtn">
						<i class="fa fa-cog"></i> Custom Settings
					</button>
				</div>
			</div>
			<div class="row">
				<div class="col-xs-12">
					<div id="editor"></div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-6">
					<select class="form-control" name="lang" id="lang">
						<option value="JavaScript">JavaScript (Node.js v4.4.3)</option>
						<option value="C#">C# (mono 4.2.3)</option>
						<option value="C++">C++ (g++ 4.8.4)</option>
						<option value="Haskell">Haskell (ghc 7.6.3)</option>
						<option value="Java">Java (openjdk 1.7.0_91)</option>
						<option value="Objective-C">Objective-C (clang 3.3)</option>
						<option value="Perl">Perl (perl 5.18.2)</option>
						<option value="Pascal">Pascal (fpc 2.6.2)</option>
						<option value="Python">Python (python 2.7.6)</option>
					</select>
				</div>
				<div class="col-sm-6 text-center">
					<button id="runBtn" type="button" class="btn btn-default">Run</button>
				</div>
			</div>
			<div class="row">
				<div class="col-xs=12">
					<!-- TODO: some sort of element to hold console -->
					<div id="outConsole"></div>
				</div>
			</div>
			<!-- / UI COMPONENT -->

			<!-- CONFIG MODAL -->
			<div class="modal" id="configModal" tabindex="-1" role="dialog" aria-labelledby="configModalLabel">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
							<h4 class="modal-title" id="configModalLabel">Custom Settings</h4>
						</div>
						<div class="modal-body">
							<div class="row">
								<div class="col-md-6">Tab Size</div>
								<div class="col-md-6">
									<input type="number" class="form-control" />
								</div>
								
								<div class="col-md-6">Font Size</div>
								<div class="col-md-6">
									<input type="number" class="form-control" />
								</div>
								
								
								<!-- 
									TODO:

									- Allow user to switch between themes

									- Allow user to change the following parameters
										- tab size
										- font size
					
									- Allow user to have custom key bindings for
										- GOTO line
										- SEARCH (save last used phrase)
										- REPLACE 
									- (utilize https://bootstrap-tagsinput.github.io/bootstrap-tagsinput/examples/)

								-->
							</div>
						</div>
						<div class="modal-footer">
							<button id="configSave" type="button" class="btn btn-primary">
								<i class="fa fa-save"></i>  Save Changes
							</button>
						</div>
					</div>
				</div>
			</div>
			<!-- /. CONFIG MODAL -->

		</sectino>

		<!-- Scripts -->
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/ace.js" data-ace-base="ace" charset="utf-8"></script>
		
		<!--
			For local testing:
			http://stackoverflow.com/questions/20035101/no-access-control-allow-origin-header-is-present-on-the-requested-resource

			HIGH LEVEL TODO:
				- implement search / GOTO window
		-->

		<!-- Factory Function -->
		<script type="text/javascript">
			var aceEditor;
			function CodeEditor(options) {

				var clientSecretKey = '9b3e30247878ad73b13bdae8a333c74afe4877fb', // TODO: move to env var later
					//aceEditor,
					lang = options.lang, 
					theme = options.theme,
					aceLangMap = { // user label to ace .js file name 
						'C#'			: 'csharp',
						'C++'			: 'c_pp',
						'Haskell'		: 'haskell',
						'Java'			: 'java',
						'JavaScript'	: 'javascript',
						'Objective-C'	: 'objectivec',
						'Perl'			: 'perl',
						'Pascal'		: 'pascal',
						'Python'		: 'python'	
					},
					hackerLangMap = { // user label hacker earth lang format 
						'C'				: 'C',
						'C++'			: 'CPP',
						'Clojure'		: 'CLOJURE',
						'C#'			: 'CSHARP',
						'Go'			: 'GO',
						'Haskell'		: 'HASKELL',
						'Java'			: 'JAVA',
						'JavaScript'	: 'JAVASCRIPT_NODE',
						'Objective-C'	: 'OBJECTIVEC',
						'Pascal'		: 'PASCAL',
						'Perl'			: 'PERL',
						'Python'		: 'PYTHON',
						'R'				: 'R',
						'Ruby'			: 'RUBY',
						'Scala'			: 'Scala'
					},
					extensionMap = {
						'C#'			: '.cs',
						'C++'			: '.cpp',
						'Haskell'		: '.hs',
						'Java'			: '.java',
						'JavaScript'	: '.js',
						'Objective-C'	: '.m',
						'Perl'			: '.perl',
						'Pascal'		: '.pas',
						'Python'		: '.py'	
					},
					defaultSearchSettings = {
						backwards		: false,
						wrap 			: true,
						caseSensitive   : false,
						wholeWord		: false,
						regExp 			: false
					};
					defaultConfig = {
						// TODO
					},
					constants = {
						'COMPILE_OK'	: 'OK'
					};

				// UTIL module
				var util = (function() {

					function isInteger(num) {
						return (typeof(num) === 'number' && num % 1 === 0);	
					}

					return {
						isInteger	: isInteger
					};

				})();


				// EXECUTE module
				var execute = (function(options) {

					var $outConsole = options.$outConsole;

					function run($btn) {
						if (!editor.getEditorText()) {
							alert('Please enter at least one statement to run.');
							$btn.prop('disabled', false);
							return;
						}
						
						$outConsole.html('Working...');

						$.ajax({
							url: 'https://api.hackerearth.com/v3/code/run/',
							type: 'POST',
							dataType: 'json',
							data: {
								client_secret: clientSecretKey,
								lang: hackerLangMap[lang],
								source: editor.getEditorText()
							},
						})
						.done(function(data, textStatus, jqXHR) {
							// Check for comilation errors
							if (data.compile_status !== constants.COMPILE_OK) {
								var textErr = data.run_status.status_detail + 
									'<br/>' + data.comile_status;
								$outConsole.html(textErr);
								return;
							}

							var resp = data.run_status;
							var consoleOutput = "Time Used: " + resp.time_used + "<br/><br/>";

							// Check if there were runtime errors
							if (resp.stderr) {
								consoleOutput += resp.stderr;
							} else {
								consoleOutput += resp.output_html;			
							}
							$outConsole.html(consoleOutput);
						})
						.fail(function(jqXHR, textStatus, errorThrown) {
							$outConsole.html('Sorry, something went wrong! Please refresh and try again.');
						})
						.always(function() {
							$btn.prop('disabled', false);
						});
					}

					return {
						run 	: run
					};

				})(options.execute);

				// EDITOR module
				var editor = (function(options) {

					var $filename = options.$filename;
					var $extension = options.$extension;

					function initEditor(eleId, theme, lang) {
						aceEditor = ace.edit(eleId);
						setEditorTheme(theme);
						setEditorLang(lang);
						aceEditor.setAutoScrollEditorIntoView(true);
						aceEditor.getSession().setTabSize(4);
					}

					function getEditorText() {
						return aceEditor.getValue();
					}

					function download() {
						// lib will automatically replace any non-valid filename chars with '-'
						var filename = $filename.val();
						if (!$filename.val()) {
							alert('Please enter a filename.');
							return;
						}
						var text = getEditorText();
						var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
						saveAs(blob, filename + extensionMap[lang]);
					}

					function setEditorTheme(theme) {
						aceEditor.setTheme("ace/theme/" + theme);
					}

					function setEditorLang(newLang) {
						lang = newLang;
						aceEditor.getSession().setMode("ace/mode/" + aceLangMap[lang]);
						$extension.html(extensionMap[lang]);
					}

					function setTabSize(size) {
						if (util.isInteger(size)) {
							aceEditor.getSession().setTabSize(size);	
						}
					}

					function goToLine(lineNumber) {
						if (util.isInteger(size)) {
							aceEditor.gotoLine(lineNumber);
						}
					}

					function find(phrase, backwards, regExp) {
						if (!phrase) {
							return;
						}
						var options = $.extend({}, defaultSearchSettings);
						if (direction) {
							options.backwards = true;
						}
						if (regExp) {
							options.regExp = true;
						}
						aceEditor.find(phrase, options);
					}

					return {
						initEditor		: initEditor,
						download		: download,
						getEditorText	: getEditorText,
						setEditorTheme	: setEditorTheme,
						setEditorLang	: setEditorLang
					};

				})(options.editor);

				// "CONSTRUCTOR"
				(function() {
					editor.initEditor(options.eleId, theme, lang);
				})();

				// Return modules
				return {
					editor 		: editor,
					execute 	: execute
				};

			}
		</script>

		<!-- Main Script -->
		<script type="text/javascript">
			
			var codeEditor; // global class instance

			$(document).ready(function() {

				codeEditor = CodeEditor({
					eleId		: 'editor',
					lang 		: 'JavaScript',
					theme 		: 'monokai',
					execute		: {
						$outConsole	: $('#outConsole'),
					},
					editor 		: {
						$filename 	: $('#filename'),
						$extension	: $('#extension')
					}
				});

				// Bindings
				$('#codeeditor #runBtn').click(function() {
					$(this).prop('disabled', true);
					codeEditor.execute.run($(this));
				});
				$('#codeeditor #saveBtn').click(function() { // TODO: Hook up
					alert('Code snippet save feature -- coming soon...');
				});
				$('#codeeditor #downloadBtn').click(codeEditor.editor.download);
				$('#codeeditor #configBtn').click(function() {
					codeEdotr.util.configWindow();
				});

				$('#codeeditor #lang').on('change', function() {
					var lang = $(this).find('option:selected').val();
					codeEditor.editor.setEditorLang(lang);
				});

			});

		</script>
	</body>
</html>
